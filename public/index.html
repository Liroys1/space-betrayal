<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Exo+2:wght@300;400;600;700&display=swap" rel="stylesheet">
  <title>Space Betrayal</title>
  <link rel="manifest" href="/manifest.json">
  <meta name="theme-color" content="#1a1a3e">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Space Betrayal">
  <link rel="apple-touch-icon" href="/icon-192.png">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { background: #0a0a1a; overflow: hidden; font-family: 'Exo 2', 'Segoe UI', Arial, sans-serif; color: #fff; touch-action: none; -webkit-touch-callout: none; -webkit-user-select: none; user-select: none; }
    canvas { display: block; touch-action: none; }

    .overlay {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      display: none; justify-content: center; align-items: center;
      z-index: 10; background: rgba(0,0,0,0.7);
    }
    .overlay.active { display: flex; }

    .panel {
      background: linear-gradient(135deg, #1a1a3e, #0d0d2b);
      border: 2px solid #333;
      border-radius: 16px; padding: 40px; color: #fff;
      min-width: 340px; text-align: center;
      box-shadow: 0 0 40px rgba(100, 100, 255, 0.1);
    }

    h1 { font-family: 'Orbitron', sans-serif; font-size: 2.5em; margin-bottom: 10px; letter-spacing: 4px; color: #ff4444; text-shadow: 0 0 20px rgba(255,68,68,0.5), 0 0 60px rgba(255,68,68,0.2); }
    h2 { font-size: 1.5em; margin-bottom: 15px; color: #aaa; }
    h3 { font-size: 1.2em; margin-bottom: 10px; }

    .subtitle { color: #888; font-size: 0.9em; margin-bottom: 25px; }

    input[type="text"] {
      width: 100%; padding: 12px 16px; margin: 8px 0;
      background: #111; border: 2px solid #333; border-radius: 8px;
      color: #fff; font-size: 1em; outline: none;
      transition: border-color 0.2s;
    }
    input[type="text"]:focus { border-color: #5555ff; }
    input[type="text"]::placeholder { color: #555; }

    .btn {
      display: inline-block; padding: 12px 30px; margin: 8px 4px;
      background: #2a2a6a; border: 2px solid #4444aa; border-radius: 8px;
      color: #fff; font-size: 1em; cursor: pointer;
      transition: all 0.2s; font-weight: bold;
    }
    .btn:hover { background: #3a3a8a; border-color: #6666cc; transform: translateY(-1px); }
    .btn.primary { background: #cc3333; border-color: #ff4444; }
    .btn.primary:hover { background: #dd4444; }
    .btn.success { background: #227722; border-color: #33aa33; }
    .btn.success:hover { background: #33aa33; }
    .btn:disabled { opacity: 0.4; cursor: not-allowed; transform: none; }

    .room-code {
      font-size: 2.5em; letter-spacing: 8px; font-weight: bold;
      color: #ffdd44; margin: 15px 0;
      text-shadow: 0 0 10px rgba(255,221,68,0.3);
    }

    .player-list {
      list-style: none; margin: 15px 0; max-height: 250px;
      overflow-y: auto; text-align: left;
    }
    .player-list li {
      padding: 8px 12px; margin: 4px 0;
      background: rgba(255,255,255,0.05); border-radius: 6px;
      display: flex; align-items: center; gap: 10px;
    }
    .player-color {
      width: 24px; height: 24px; border-radius: 50%;
      border: 2px solid rgba(255,255,255,0.3); flex-shrink: 0;
    }
    .player-name { flex: 1; }
    .host-badge { font-size: 0.8em; color: #ffdd44; }

    /* Skin customizer */
    .skin-customizer {
      background: rgba(0,0,0,0.3); border-radius: 12px; padding: 15px;
      margin: 15px 0; display: flex; flex-direction: column; align-items: center; gap: 10px;
    }
    #skin-preview { border-radius: 8px; background: rgba(0,0,0,0.4); }
    .skin-row {
      display: flex; align-items: center; gap: 8px;
    }
    .skin-arrow {
      background: #2a2a6a; border: 1px solid #4444aa; border-radius: 6px;
      color: #fff; width: 32px; height: 32px; font-size: 14px;
      cursor: pointer; display: flex; align-items: center; justify-content: center;
      transition: background 0.2s;
    }
    .skin-arrow:hover { background: #3a3a8a; }
    .skin-label {
      min-width: 100px; text-align: center; font-size: 0.95em; color: #ddd;
    }
    .skin-category { font-size: 0.8em; color: #888; min-width: 45px; }

    .divider { border: none; border-top: 1px solid #333; margin: 20px 0; }

    .error-msg { color: #ff4444; font-size: 0.9em; margin: 8px 0; min-height: 1.2em; }

    /* Meeting screen */
    .meeting-panel {
      background: linear-gradient(135deg, #1a1a3e, #0d0d2b);
      border: 2px solid #333; border-radius: 16px; padding: 30px;
      min-width: 500px; max-width: 700px; max-height: 80vh; overflow-y: auto;
    }
    .meeting-header { font-size: 1.3em; margin-bottom: 15px; color: #ffaa00; }
    .timer { font-size: 1.5em; color: #ff4444; margin: 10px 0; }

    .vote-grid {
      display: grid; grid-template-columns: 1fr 1fr;
      gap: 8px; margin: 15px 0;
    }
    .vote-card {
      padding: 10px; background: rgba(255,255,255,0.05);
      border: 2px solid #333; border-radius: 8px;
      cursor: pointer; display: flex; align-items: center; gap: 8px;
      transition: all 0.2s;
    }
    .vote-card:hover:not(.dead):not(.voted):not(.disabled) {
      border-color: #5555ff; background: rgba(85,85,255,0.1);
    }
    .vote-card.dead { opacity: 0.3; cursor: default; text-decoration: line-through; }
    .vote-card.selected { border-color: #ff4444; background: rgba(255,68,68,0.2); }
    .vote-card.disabled { cursor: default; }
    .vote-card .check { margin-left: auto; color: #44ff44; display: none; }
    .vote-card .check.visible { display: inline; }

    /* Meeting Chat */
    .meeting-chat {
      margin-top: 12px; border-top: 1px solid #333; padding-top: 10px;
    }
    .chat-messages {
      max-height: 120px; overflow-y: auto; margin-bottom: 8px;
      font-size: 0.85em; line-height: 1.4;
    }
    .chat-messages .chat-msg {
      padding: 3px 0; word-break: break-word;
    }
    .chat-messages .chat-msg .chat-name {
      font-weight: bold; margin-right: 6px;
    }
    .chat-messages .chat-ghost {
      opacity: 0.5; font-style: italic;
    }
    .chat-input-row {
      display: flex; gap: 6px;
    }
    .chat-input-row input {
      flex: 1; padding: 6px 10px; border-radius: 6px;
      border: 1px solid #444; background: rgba(255,255,255,0.08); color: #fff;
      font-size: 0.9em;
    }
    .chat-input-row .btn {
      padding: 6px 14px; font-size: 0.85em;
    }

    /* Settings */
    .setting-row {
      display: flex; justify-content: space-between; align-items: center;
      padding: 4px 0;
    }
    .achieve-toast {
      position: fixed; top: 60px; left: 50%; transform: translateX(-50%);
      background: rgba(20, 10, 40, 0.95); color: #ffcc00; border: 2px solid #ffcc00;
      border-radius: 10px; padding: 10px 20px; font-size: 0.9em; font-weight: bold;
      z-index: 9999; animation: toastIn 0.5s ease, toastOut 0.5s ease 3.5s forwards;
      pointer-events: none;
    }
    @keyframes toastIn { from { opacity: 0; top: 30px; } to { opacity: 1; top: 60px; } }
    @keyframes toastOut { from { opacity: 1; } to { opacity: 0; } }
    .achieve-item { padding: 6px 0; border-bottom: 1px solid rgba(255,255,255,0.1); }
    .achieve-item.locked { opacity: 0.4; }
    .achieve-icon { font-size: 1.2em; margin-right: 6px; }
    .setting-row label { color: #aaa; }
    .setting-row select {
      background: rgba(255,255,255,0.1); color: #fff; border: 1px solid #444;
      border-radius: 4px; padding: 3px 6px; font-size: 0.9em;
    }

    /* Results */
    .result-text { font-size: 1.5em; margin: 20px 0; }
    .result-role { font-size: 1.1em; margin: 10px 0; }

    /* Game over */
    .gameover-panel {
      background: linear-gradient(135deg, #1a1a3e, #0d0d2b);
      border: 2px solid #333; border-radius: 16px; padding: 40px;
      min-width: 400px; max-width: 600px; text-align: center;
    }
    .gameover-panel.crewmates { border-color: #33aa33; }
    .gameover-panel.impostors { border-color: #ff4444; }
    .win-title { font-size: 2em; margin-bottom: 10px; }
    .win-reason { color: #aaa; margin-bottom: 20px; }
    .role-list { list-style: none; text-align: left; margin: 15px 0; }
    .role-list li {
      padding: 6px 10px; margin: 3px 0; border-radius: 4px;
      display: flex; align-items: center; gap: 8px;
      background: rgba(255,255,255,0.05);
    }
    .role-list .role-tag { font-size: 0.8em; padding: 2px 6px; border-radius: 4px; }
    .role-tag.impostor { background: #ff4444; }
    .role-tag.crewmate { background: #33aa33; }
    .dead-marker { color: #ff4444; font-size: 0.8em; }

    /* Task overlay */
    .task-panel {
      background: linear-gradient(135deg, #1a1a3e, #0d0d2b);
      border: 2px solid #333; border-radius: 16px; padding: 20px;
      width: 90vw; max-width: 420px; position: relative;
    }
    .task-title { font-size: 1.2em; margin-bottom: 10px; }
    #task-canvas { display: block; margin: 0 auto; border-radius: 8px; background: #111; width: 100%; max-width: 350px; touch-action: none; }
    .task-close {
      position: absolute; top: 8px; right: 12px;
      font-size: 2em; cursor: pointer; color: #aaa;
      width: 40px; height: 40px; display: flex; align-items: center; justify-content: center;
      z-index: 5;
    }
    .task-close:hover { color: #fff; }

    /* Color picker */
    .color-grid {
      display: flex; flex-wrap: wrap; justify-content: center; gap: 6px; margin: 8px 0;
    }
    .color-swatch {
      width: 28px; height: 28px; border-radius: 50%; cursor: pointer;
      border: 3px solid transparent; transition: all 0.2s;
    }
    .color-swatch:hover { transform: scale(1.15); }
    .color-swatch.selected { border-color: #fff; box-shadow: 0 0 8px rgba(255,255,255,0.5); }
    .color-swatch.taken { opacity: 0.25; cursor: not-allowed; }

    /* Mobile joystick */
    #mobile-joystick {
      display: none; position: fixed; bottom: 30px; left: 30px; z-index: 20;
      width: 130px; height: 130px; touch-action: none;
    }
    #mobile-joystick .joystick-base {
      position: absolute; width: 130px; height: 130px; border-radius: 50%;
      background: rgba(255,255,255,0.08); border: 2px solid rgba(255,255,255,0.15);
    }
    #mobile-joystick .joystick-thumb {
      position: absolute; width: 50px; height: 50px; border-radius: 50%;
      background: rgba(255,255,255,0.25); border: 2px solid rgba(255,255,255,0.3);
      left: 40px; top: 40px; transition: none;
    }

    /* Mobile action buttons */
    #mobile-actions {
      display: none; position: fixed; bottom: 30px; right: 20px; z-index: 20;
    }
    .mobile-action-btn {
      width: 68px; height: 68px; border-radius: 50%; border: 2px solid rgba(255,255,255,0.3);
      font-family: 'Exo 2', sans-serif; font-weight: 700; font-size: 12px; color: #fff;
      display: flex; align-items: center; justify-content: center; text-align: center;
      margin: 6px; cursor: pointer; touch-action: none; line-height: 1.1;
      box-shadow: 0 2px 8px rgba(0,0,0,0.4);
      user-select: none; -webkit-user-select: none;
    }

    /* RTL adjustments */
    [dir="rtl"] .chat-messages .chat-name { margin-right: 0; margin-left: 6px; }
    [dir="rtl"] .setting-row { direction: rtl; }
    [dir="rtl"] .player-list li { direction: rtl; }
    [dir="rtl"] .chat-input-row { direction: rtl; }
    [dir="rtl"] .skin-row { direction: rtl; }
    [dir="rtl"] .role-list li { direction: rtl; }
    [dir="rtl"] .host-badge { margin-right: auto; margin-left: 0; }
    [dir="rtl"] h1, [dir="rtl"] h2, [dir="rtl"] h3 { direction: rtl; }

    @media (max-width: 768px) {
      .panel { min-width: unset; width: 92vw; max-width: 400px; padding: 20px 15px; }
      .panel, .meeting-panel, .gameover-panel, .task-panel { max-height: 90vh; overflow-y: auto; }
      h1 { font-size: 1.6em; letter-spacing: 2px; }
      h2 { font-size: 1.2em; }
      .meeting-panel { min-width: unset; width: 95vw; padding: 15px 10px; }
      .gameover-panel { min-width: unset; width: 92vw; }
      .vote-grid { grid-template-columns: 1fr; }
      .room-code { font-size: 1.8em; letter-spacing: 4px; }
      .skin-customizer { padding: 8px; }
      .btn { padding: 10px 20px; font-size: 0.9em; }
      .task-panel { width: 95vw; padding: 15px 10px; }
      .task-close { font-size: 2.2em; top: 5px; right: 8px; width: 44px; height: 44px; }
      .player-list { max-height: 150px; }
      input[type="text"] { font-size: 16px; } /* prevent iOS zoom */
    }
  </style>
</head>
<body>
  <canvas id="gameCanvas"></canvas>
  <canvas id="confetti-overlay" style="position:fixed;top:0;left:0;width:100%;height:100%;pointer-events:none;z-index:1000"></canvas>

  <!-- MENU SCREEN -->
  <div id="menu-screen" class="overlay active">
    <div class="panel">
      <h1>SPACE BETRAYAL</h1>
      <p class="subtitle">A social deduction game</p>
      <input type="text" id="name-input" placeholder="Enter your name" maxlength="12" />
      <div class="error-msg" id="menu-error"></div>
      <button class="btn primary" id="create-btn">Create Game</button>
      <hr class="divider">
      <input type="text" id="code-input" placeholder="Room code" maxlength="6" style="text-transform:uppercase" />
      <button class="btn" id="join-btn">Join Game</button>
      <button class="btn" id="spectate-btn" style="font-size:0.85em;margin-top:4px">Spectate</button>
      <div style="margin-top:12px;display:flex;gap:8px;justify-content:center;flex-wrap:wrap">
        <button class="btn" id="browse-btn" style="font-size:0.85em;padding:6px 14px">Browse Rooms</button>
        <button class="btn" id="stats-btn" style="font-size:0.85em;padding:6px 14px">Stats</button>
        <button class="btn" id="achieve-btn" style="font-size:0.85em;padding:6px 14px">Achievements</button>
        <button class="btn" id="challenges-btn" style="font-size:0.85em;padding:6px 14px">Challenges</button>
        <button class="btn" id="friends-btn" style="font-size:0.85em;padding:6px 14px">Friends</button>
      </div>
      <button class="btn" id="lang-btn" style="margin-top:10px;font-size:0.85em;padding:6px 14px">עברית / EN</button>
      <button class="btn" id="install-btn" style="display:none;margin-top:10px;font-size:0.85em;padding:8px 18px;background:#226622;border-color:#33aa33">Install App</button>
      <div id="ios-install-hint" style="display:none;margin-top:8px;font-size:0.75em;color:#aaa;background:rgba(0,0,0,0.3);border-radius:6px;padding:6px 10px">Tap <strong style="color:#fff">Share</strong> then <strong style="color:#fff">Add to Home Screen</strong> to install</div>
      <div id="volume-controls" style="margin-top:14px;background:rgba(0,0,0,0.3);border-radius:8px;padding:10px 14px;font-size:0.8em">
        <div style="display:flex;align-items:center;gap:8px;margin-bottom:6px"><label style="width:55px;color:#aaa">Master</label><input type="range" id="vol-master" min="0" max="100" value="70" style="flex:1;accent-color:#6644cc"></div>
        <div style="display:flex;align-items:center;gap:8px;margin-bottom:6px"><label style="width:55px;color:#aaa">SFX</label><input type="range" id="vol-sfx" min="0" max="100" value="80" style="flex:1;accent-color:#6644cc"></div>
        <div style="display:flex;align-items:center;gap:8px"><label style="width:55px;color:#aaa">Music</label><input type="range" id="vol-music" min="0" max="100" value="40" style="flex:1;accent-color:#6644cc"></div>
      </div>
    </div>
  </div>

  <!-- STATS PANEL -->
  <div id="stats-panel" class="overlay">
    <div class="panel" style="max-width:360px">
      <h2>PLAYER STATS</h2>
      <div id="stats-content" style="text-align:left;font-size:0.9em;line-height:2"></div>
      <button class="btn" id="stats-close" style="margin-top:12px">Close</button>
    </div>
  </div>

  <!-- ROOM BROWSER -->
  <div id="browse-panel" class="overlay">
    <div class="panel" style="max-width:400px">
      <h2>PUBLIC ROOMS</h2>
      <div id="room-list" style="text-align:left;max-height:350px;overflow-y:auto;font-size:0.9em"></div>
      <p style="color:#666;font-size:0.8em;margin:8px 0">Only rooms set to Public are shown</p>
      <button class="btn" id="browse-refresh" style="margin-right:8px">Refresh</button>
      <button class="btn" id="browse-close">Close</button>
    </div>
  </div>

  <!-- ACHIEVEMENTS PANEL -->
  <div id="achieve-panel" class="overlay">
    <div class="panel" style="max-width:400px">
      <h2>ACHIEVEMENTS</h2>
      <div id="achieve-content" style="text-align:left;font-size:0.85em;max-height:400px;overflow-y:auto"></div>
      <button class="btn" id="achieve-close" style="margin-top:12px">Close</button>
    </div>
  </div>

  <!-- FRIENDS PANEL -->
  <div id="friends-panel" class="overlay">
    <div class="panel" style="max-width:380px">
      <h2 id="friends-title">FRIENDS</h2>
      <div style="margin-bottom:10px">
        <span style="color:#aaa;font-size:0.85em" id="friends-your-code-label">Your Code:</span>
        <span id="friends-my-code" style="font-size:1.3em;color:#ffdd44;letter-spacing:3px;font-weight:bold;margin-left:6px"></span>
      </div>
      <div style="display:flex;gap:6px;margin-bottom:12px">
        <input type="text" id="friend-code-input" placeholder="Friend code" maxlength="6" style="flex:1;text-transform:uppercase;font-size:0.9em;padding:8px">
        <button class="btn" id="friend-add-btn" style="font-size:0.85em;padding:6px 14px">Add</button>
      </div>
      <div id="friends-list" style="text-align:left;max-height:250px;overflow-y:auto;font-size:0.9em"></div>
      <button class="btn" id="friends-close" style="margin-top:12px">Close</button>
    </div>
  </div>

  <!-- CHALLENGES PANEL -->
  <div id="challenges-panel" class="overlay">
    <div class="panel" style="max-width:400px">
      <h2 id="challenges-title">DAILY CHALLENGES</h2>
      <div id="challenges-stars" style="font-size:1.1em;color:#ffcc00;margin-bottom:8px"></div>
      <div id="challenges-streak" style="font-size:0.85em;color:#aaa;margin-bottom:12px"></div>
      <div id="challenges-list" style="text-align:left;font-size:0.9em"></div>
      <div id="challenges-bonus" style="display:none;margin-top:10px;color:#44ff44;font-weight:bold;font-size:0.9em"></div>
      <button class="btn" id="challenges-close" style="margin-top:12px">Close</button>
    </div>
  </div>

  <!-- LOBBY SCREEN -->
  <div id="lobby-screen" class="overlay">
    <div class="panel">
      <h2>LOBBY</h2>
      <p>Room Code:</p>
      <div class="room-code" id="lobby-code"></div>
      <p style="color:#888;font-size:0.85em;margin-bottom:15px">Share this code with friends</p>

      <!-- Color Picker -->
      <div id="color-picker" style="display:flex;flex-wrap:wrap;gap:5px;justify-content:center;margin-bottom:12px;max-width:280px;margin-left:auto;margin-right:auto"></div>

      <!-- Skin Customization -->
      <div class="skin-customizer">
        <canvas id="skin-preview" width="120" height="140"></canvas>
        <div class="skin-row">
          <button class="skin-arrow" id="hat-prev">&#9664;</button>
          <span class="skin-label" id="hat-label">None</span>
          <button class="skin-arrow" id="hat-next">&#9654;</button>
          <span class="skin-category">Hat</span>
        </div>
        <div class="skin-row">
          <button class="skin-arrow" id="outfit-prev">&#9664;</button>
          <span class="skin-label" id="outfit-label">None</span>
          <button class="skin-arrow" id="outfit-next">&#9654;</button>
          <span class="skin-category">Outfit</span>
        </div>
        <div class="skin-row">
          <button class="skin-arrow" id="pet-prev">&#9664;</button>
          <span class="skin-label" id="pet-label">None</span>
          <button class="skin-arrow" id="pet-next">&#9654;</button>
          <span class="skin-category">Pet</span>
        </div>
        <div class="skin-row" style="justify-content:center;gap:8px">
          <input type="file" id="avatar-input" accept="image/*" style="display:none">
          <button class="skin-arrow" id="avatar-upload-btn" style="width:auto;padding:2px 10px;font-size:0.85em">Upload Photo</button>
          <span class="skin-label" id="avatar-label" style="font-size:0.8em">No photo</span>
          <button class="skin-arrow" id="avatar-remove-btn" style="width:auto;padding:2px 8px;font-size:0.85em;display:none">X</button>
          <span class="skin-category">Face</span>
        </div>
      </div>
      <div class="color-grid" id="color-grid"></div>

      <ul class="player-list" id="lobby-players"></ul>
      <p id="lobby-count" style="color:#888;margin:10px 0"></p>

      <!-- Game Settings (host only) -->
      <div id="settings-panel" style="display:none;text-align:left;background:rgba(0,0,0,0.3);border-radius:8px;padding:12px;margin-bottom:12px;font-size:0.85em">
        <div style="text-align:center;font-weight:bold;margin-bottom:8px;color:#ffaa00">GAME SETTINGS</div>
        <div class="setting-row"><label>Impostors:</label><select id="set-impostors"><option value="1">1</option><option value="2">2</option><option value="3">3</option></select></div>
        <div class="setting-row"><label>Kill Cooldown:</label><select id="set-killcd"><option value="10">10s</option><option value="20">20s</option><option value="30" selected>30s</option><option value="45">45s</option></select></div>
        <div class="setting-row"><label>Player Speed:</label><select id="set-speed"><option value="2">Slow</option><option value="3" selected>Normal</option><option value="4">Fast</option><option value="5">Very Fast</option></select></div>
        <div class="setting-row"><label>Tasks:</label><select id="set-tasks"><option value="2">2</option><option value="3">3</option><option value="5" selected>5</option><option value="7">7</option></select></div>
        <div class="setting-row"><label>Discussion:</label><select id="set-discuss"><option value="15" selected>15s</option><option value="30">30s</option><option value="60">60s</option><option value="120">120s</option></select></div>
        <div class="setting-row"><label>Voting:</label><select id="set-voting"><option value="30">30s</option><option value="60">60s</option><option value="120" selected>120s</option><option value="180">180s</option></select></div>
        <div class="setting-row"><label>Crew Vision:</label><select id="set-crewvision"><option value="0.5">0.5x</option><option value="1" selected>1x</option><option value="1.5">1.5x</option></select></div>
        <div class="setting-row"><label>Impostor Vision:</label><select id="set-impvision"><option value="1">1x</option><option value="1.5" selected>1.5x</option><option value="2">2x</option></select></div>
        <div class="setting-row"><label>Confirm Ejects:</label><select id="set-confirmeject"><option value="1" selected>On</option><option value="0">Off</option></select></div>
        <div class="setting-row"><label>Anonymous Votes:</label><select id="set-anonvotes"><option value="0" selected>Off</option><option value="1">On</option></select></div>
        <div class="setting-row"><label>Special Roles:</label><select id="set-specialroles"><option value="0" selected>Off</option><option value="1">On</option></select></div>
        <div class="setting-row"><label>Map:</label><select id="set-map"><option value="alpha" selected>The Skeld</option><option value="beta">Space Station Beta</option></select></div>
        <div class="setting-row"><label>Game Mode:</label><select id="set-gamemode"><option value="classic" selected>Classic</option><option value="hideseek">Hide & Seek</option><option value="speedrun">Speed Run</option><option value="infection">Infection</option></select></div>
        <div class="setting-row"><label>Public Room:</label><button class="btn" id="toggle-public-btn" style="font-size:0.8em;padding:3px 10px">Make Public</button></div>
      </div>

      <button class="btn success" id="start-btn" style="display:none">Start Game</button>
      <p id="lobby-wait" style="color:#888;font-size:0.9em;display:none">Waiting for host to start...</p>
    </div>
  </div>

  <!-- MEETING SCREEN -->
  <div id="meeting-screen" class="overlay">
    <div class="meeting-panel">
      <div class="meeting-header" id="meeting-header"></div>
      <div class="timer" id="meeting-timer"></div>
      <p id="meeting-phase-label" style="color:#aaa;margin-bottom:10px"></p>
      <div class="vote-grid" id="vote-grid"></div>
      <button class="btn" id="skip-btn" style="margin-top:10px">Skip Vote</button>
      <div class="meeting-draw" style="margin-top:10px;border-top:1px solid #333;padding-top:8px">
        <div style="display:flex;align-items:center;gap:6px;margin-bottom:6px;flex-wrap:wrap;justify-content:center">
          <span style="font-size:0.8em;color:#aaa" id="draw-label">Draw:</span>
          <div class="draw-color-btn" data-color="#ffffff" style="width:22px;height:22px;border-radius:50%;background:#ffffff;border:2px solid #555;cursor:pointer"></div>
          <div class="draw-color-btn" data-color="#ff4444" style="width:22px;height:22px;border-radius:50%;background:#ff4444;border:2px solid #555;cursor:pointer"></div>
          <div class="draw-color-btn" data-color="#44ff44" style="width:22px;height:22px;border-radius:50%;background:#44ff44;border:2px solid #555;cursor:pointer"></div>
          <div class="draw-color-btn" data-color="#4488ff" style="width:22px;height:22px;border-radius:50%;background:#4488ff;border:2px solid #555;cursor:pointer"></div>
          <div class="draw-color-btn" data-color="#ffdd44" style="width:22px;height:22px;border-radius:50%;background:#ffdd44;border:2px solid #555;cursor:pointer"></div>
          <button class="btn" id="draw-eraser" style="font-size:0.7em;padding:3px 8px">Eraser</button>
          <button class="btn" id="draw-clear" style="font-size:0.7em;padding:3px 8px">Clear</button>
        </div>
        <canvas id="meeting-draw-canvas" width="300" height="150" style="display:block;margin:0 auto;border-radius:6px;background:#1a1a2e;border:1px solid #333;touch-action:none;cursor:crosshair"></canvas>
      </div>
      <div class="meeting-chat">
        <div class="chat-messages" id="chat-messages"></div>
        <div class="chat-input-row">
          <input type="text" id="chat-input" placeholder="Type a message..." maxlength="200" autocomplete="off">
          <button class="btn" id="chat-send">Send</button>
        </div>
      </div>
    </div>
  </div>

  <!-- RESULTS SCREEN -->
  <div id="results-screen" class="overlay">
    <div class="panel">
      <h2>VOTING RESULTS</h2>
      <div class="result-text" id="result-text"></div>
      <div class="result-role" id="result-role"></div>
    </div>
  </div>

  <!-- GAME OVER SCREEN -->
  <div id="gameover-screen" class="overlay">
    <div class="gameover-panel" id="gameover-panel">
      <div class="win-title" id="win-title"></div>
      <div class="win-reason" id="win-reason"></div>
      <ul class="role-list" id="role-list"></ul>
      <div id="gameover-wait" style="display:none;margin-top:15px;color:#aaa;font-size:14px">Waiting for host to start next round...</div>
      <button class="btn" id="replay-btn" style="margin-top:12px;background:#2266bb" data-i18n="watchReplay">Watch Replay</button>
      <button class="btn primary" id="lobby-btn" style="display:none;margin-top:20px">Back to Lobby</button>
      <button class="btn" id="leave-btn" style="display:none;margin-top:10px;background:#666">Leave Room</button>
    </div>
  </div>

  <!-- REPLAY VIEWER -->
  <div id="replay-screen" class="overlay" style="display:none">
    <div style="position:absolute;top:0;left:0;width:100%;height:100%;background:#111">
      <canvas id="replay-canvas" style="width:100%;height:calc(100% - 60px);display:block"></canvas>
      <div id="replay-controls" style="position:absolute;bottom:0;left:0;right:0;height:60px;background:#222;display:flex;align-items:center;padding:0 12px;gap:8px">
        <button id="replay-play" class="btn" style="padding:4px 12px;font-size:14px;min-width:50px">&#9654;</button>
        <span id="replay-time" style="color:#ccc;font-size:12px;min-width:70px">0:00/0:00</span>
        <input type="range" id="replay-slider" min="0" max="1000" value="0" style="flex:1;cursor:pointer">
        <select id="replay-speed" style="background:#333;color:#fff;border:1px solid #555;padding:2px 6px;font-size:12px">
          <option value="1">1x</option>
          <option value="2">2x</option>
          <option value="4">4x</option>
        </select>
        <button id="replay-close" class="btn" style="padding:4px 12px;font-size:12px;background:#c44">&#10005;</button>
      </div>
    </div>
  </div>

  <!-- TASK SCREEN -->
  <div id="task-screen" class="overlay">
    <div class="task-panel">
      <span class="task-close" id="task-close">&times;</span>
      <div class="task-title" id="task-title"></div>
      <canvas id="task-canvas" width="350" height="250"></canvas>
    </div>
  </div>

  <!-- Mobile Controls -->
  <div id="mobile-joystick">
    <div class="joystick-base"></div>
    <div class="joystick-thumb" id="joystick-thumb"></div>
  </div>
  <div id="mobile-actions"></div>

  <button id="voice-btn" style="position:fixed;top:10px;right:10px;z-index:9000;padding:6px 14px;border:2px solid #555;border-radius:8px;color:#fff;font-family:'Exo 2',Arial;font-size:0.8em;cursor:pointer;background:#444;display:none">Voice Off</button>

  <script>
    // Service Worker Registration
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('/sw.js').catch(() => {});
      });
    }

    // PWA Install Prompt
    let deferredPrompt = null;
    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault();
      deferredPrompt = e;
      const btn = document.getElementById('install-btn');
      if (btn) btn.style.display = 'inline-block';
    });
    document.addEventListener('click', (e) => {
      if (e.target.id === 'install-btn' && deferredPrompt) {
        deferredPrompt.prompt();
        deferredPrompt.userChoice.then(() => { deferredPrompt = null; });
        e.target.style.display = 'none';
      }
    });
    window.addEventListener('appinstalled', () => {
      const btn = document.getElementById('install-btn');
      if (btn) btn.style.display = 'none';
      deferredPrompt = null;
    });

    // iOS detection — show manual install hint
    if (/iPad|iPhone|iPod/.test(navigator.userAgent) && !navigator.standalone && !window.matchMedia('(display-mode: standalone)').matches) {
      const hint = document.getElementById('ios-install-hint');
      if (hint) hint.style.display = 'block';
    }
  </script>
  <script src="/socket.io/socket.io.js"></script>
  <script src="lang.js"></script>
  <script src="sounds.js"></script>
  <script src="game.js"></script>
</body>
</html>
